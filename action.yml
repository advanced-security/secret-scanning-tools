name: 'secret-scanning-custom-action'
description: 'Testing Suite for GitHub Secret Scanning Custom Patterns'

inputs:
  repository:
    description: Repository owner and repo name
    default: ${{ github.repository }}

  token:
    description: GitHub Personal Access Token
    default: ${{ github.token }}

  mode:
    description: Secret Scanning Test Suite Mode
    default: validate

  template-main:
    description: Main README Template
  
  template-patterns:
    description: Main Pattern Template

  argvs:
    description: 'Additional Arguments'


runs:
  using: "composite"
  steps:
    - uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - shell: bash
      run: |
        echo "::group::Installing Dependencies"
        pushd ${{ github.action_path }}
        python3 -m pip install pipenv && python3 -m pipenv install --system
        popd
        echo "::endgroup::"
    - shell: bash
      env:
        INPUTS_MODE: ${{ inputs.mode }}
        INPUTS_TOKEN: ${{ inputs.token }}
        INPUTS_REPOSITORY: ${{ inputs.repository }}
        INPUTS_TEMPLATE_MAIN: ${{ inputs.template-main }}
        INPUTS_TEMPLATE_PATTERNS: ${{ inputs.template-patterns }}
      run: |
        echo "::group::Running Secret Scanning tools: ${INPUTS_MODE}"

        # debug output
        echo "::debug::INPUTS_MODE: ${INPUTS_MODE}"
        echo "::debug::INPUTS_REPOSITORY: ${INPUTS_REPOSITORY}"
        echo "::debug::INPUTS_TEMPLATE_MAIN: ${INPUTS_TEMPLATE_MAIN}"
        echo "::debug::INPUTS_TEMPLATE_PATTERNS: ${INPUTS_TEMPLATE_PATTERNS}"
        echo "::debug::INPUTS_ARGVS: ${INPUTS_ARGVS}"
        echo "::debug::GITHUB_ACTION_PATH: ${GITHUB_ACTION_PATH}"

        export PYTHONPATH="${GITHUB_ACTION_PATH}"

        # if either template isn't set, use the default in the Action
        if [[ -z "${INPUTS_TEMPLATE_MAIN}" ]]; then
          echo "::notice::Using default template for main README.md"
          INPUTS_TEMPLATE_MAIN="${GITHUB_ACTION_PATH}/secretscanning/templates/README.md"
        fi

        if [[ -z "${INPUTS_TEMPLATE_PATTERNS}" ]]; then
          echo "::notice::Using default template for patterns.md"
          INPUTS_TEMPLATE_PATTERNS="${GITHUB_ACTION_PATH}/secretscanning/templates/patterns.md"
        fi

        find "${GITHUB_ACTION_PATH}" -name "*.md"
        ls "${GITHUB_ACTION_PATH}/secretscanning/"
        ls "${GITHUB_ACTION_PATH}/secretscanning/templates/"
        ls "${INPUTS_TEMPLATE_MAIN}"
        ls "${INPUTS_TEMPLATE_PATTERNS}"

        python3 -m secretscanning \
          "--${INPUTS_MODE}" \
          --github-token "${INPUTS_TOKEN}" \
          --github-repository "${INPUTS_REPOSITORY}" \
          --templates-main "${INPUTS_TEMPLATE_MAIN}" \
          --templates-patterns "${INPUTS_TEMPLATE_PATTERNS}" \
          ${{ inputs.argvs }}
